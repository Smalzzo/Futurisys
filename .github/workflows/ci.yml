name: CI + CD to Hugging Face

on:
  push:
    branches: ["**"]
    tags: ["v*.*.*"]
  pull_request:
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"
  HF_SPACE: "sma-nas/Futurisys"
  HF_MODEL_REPO: "sma-nas/Futurysis"
  HF_USERNAME: "sma-nas"

# Workflow permissions required for Pages deployments and artifact access
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  INSTALL-BUILD-TEST: 
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Installation dependances
        run: |
          python -m pip install --upgrade pip --quiet
          if [ -f requirements.txt ]; then pip install -r requirements.txt --quiet; fi
          pip install build --quiet
      - name: Build package (sdist + wheel)
        run: python -m build --quiet 2>/dev/null || python -m build
      - name: Install package in editable mode
        run: |
          pip install -e . --quiet
      - name: Tests
        run: |
          pytest --cov=app --cov-report=xml --cov-report=term-missing -q --disable-warnings
      - name: Display Coverage Summary
        if: always()
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          coverage report --skip-empty >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      - name: Build package (sdist + wheel)
        run: python -m build --quiet 2>/dev/null || python -m build
      - name: Coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage.xml
  DEPLOY-TO-HF:
    needs: [INSTALL-BUILD-TEST]
    if: >
      success() && (
        startsWith(github.ref, 'refs/heads/main') ||
        startsWith(github.ref, 'refs/tags/v')
      )
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      

      # chargement du model.pkl sur Hugging Face model repo , l'app peut le télécharger
      # et utilise le token HF stocké dans secrets.HF_SECRET.
      - name: Chargement du modèle sur HF (Model repo)
        env:
          HF_TOKEN: ${{ secrets.HF_SECRET }}
          MODEL_REPO_ID: ${{ env.HF_MODEL_REPO }}
          MODEL_FILENAME: model.pkl
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip --quiet
          pip install huggingface_hub --quiet
          python - <<'PY'
          import os, sys
          from huggingface_hub import HfApi, create_repo

          repo_id = os.environ.get('MODEL_REPO_ID')
          filename = os.environ.get('MODEL_FILENAME', 'model.pkl')
          local_path = os.path.join(os.getcwd(), 'app', 'ml', filename)

          if not os.path.isfile(local_path):
              print('Model not found at', local_path, '- skipping upload')
              sys.exit(0)

          token = os.environ.get('HF_TOKEN')
          # on créé le repo s il n existe pas
          create_repo(repo_id=repo_id, repo_type='model', private=True, token=token, exist_ok=True)

          api = HfApi(token=token)
          print('Uploading', local_path, 'to', repo_id)
          api.upload_file(
              path_or_fileobj=local_path,
              path_in_repo=filename,
              repo_id=repo_id,
              repo_type='model',
          )
          print('Upload complete')
          PY
      
      # Préparer un dossier d'upload sans .git/.github, *.db, ni fichiers binaires
      # (HF refuses binary files; the model will be downloaded at runtime)
      - name: Préparer le dossier de déploiement (sources uniquement)
        run: |
          set -e
          rm -rf deploy && mkdir deploy
          rsync -a --delete --quiet \
            --exclude='.git' --exclude='.github' \
            --exclude='*.db' --exclude='**/*.db' \
            --exclude='app/ml/model.pkl' \
            ./ deploy/
          echo "Deploy directory prepared"

      - name: Push sources vers la Space (HF build)
        env:
          HF_TOKEN: ${{ secrets.HF_SECRET }}
          HF_SPACE: ${{ env.HF_SPACE }}
        run: |
          set -e
          cd deploy
          git init -q
          git add .
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Deploy ${GITHUB_SHA}" -q
          git branch -M main
          git remote add origin "https://oauth2:${HF_TOKEN}@huggingface.co/spaces/${HF_SPACE}"
          echo "Pushing to Hugging Face Space..."
          git push -f origin main -q
          echo "Deployment successful"

