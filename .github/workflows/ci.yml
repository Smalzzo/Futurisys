name: CI + CD to Hugging Face

on:
  push:
    branches: ["**"]
    tags: ["v*.*.*"]
  pull_request:
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"
  HF_SPACE: "sma-nas/Futurisys"
  HF_USERNAME: "sma-nas"

jobs:
  INSTALL-BUILD-TEST:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Installation dependances
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install build
      - name: Build package (sdist + wheel)
        run: python -m build
      - name: Install Build
        run: |
          pip install dist/*.whl || pip install dist/*.tar.gz
      - name: Tests
        run: |
          pytest --cov=app --cov-report=xml --cov-report=term-missing
      - name: Coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage.xml
  DEPLOY-TO-HF:
    needs: [INSTALL-BUILD-TEST]
    if: >
      success() && (
        startsWith(github.ref, 'refs/heads/main') ||
        startsWith(github.ref, 'refs/tags/v')
      )
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true
      - name: Build and push Docker image to Hugging Face Spaces
        env:
          HF_TOKEN: ${{ secrets.HF_SECRET }}
          HF_SPACE: ${{ env.HF_SPACE }}
        run: |
          # Extract space ID from HF_SPACE (format: username/space-name)
          SPACE_ID=$(echo $HF_SPACE | cut -d'/' -f1)
          
          # Tag the image for HF registry
          IMAGE_TAG="spaces-registry-us.huggingface.tech/$SPACE_ID/spaces:latest"
          
          echo "Building Docker image: $IMAGE_TAG"
          docker build -t $IMAGE_TAG .
          
          echo "Logging in to HF registry..."
          echo "$HF_TOKEN" | docker login --username "${{ env.HF_USERNAME }}" --password-stdin spaces-registry-us.huggingface.tech
          
          echo "Pushing Docker image with retry logic..."
          
          # Push with enhanced retry logic for network timeouts
          max_retries=5
          retry_count=0
          retry_delay=10
          
          while [ $retry_count -lt $max_retries ]; do
            echo "Push attempt $((retry_count + 1))/$max_retries"
            
            # Set aggressive timeout to catch hanging connections early
            if timeout 600 docker push $IMAGE_TAG; then
              echo "✓ Docker push succeeded"
              exit 0
            fi
            
            push_exit=$?
            echo "Push attempt $((retry_count + 1)) failed with exit code $push_exit"
            
            retry_count=$((retry_count + 1))
            
            if [ $retry_count -lt $max_retries ]; then
              echo "Waiting ${retry_delay}s before retry..."
              sleep $retry_delay
              retry_delay=$((retry_delay + 10))  # Exponential backoff: 10s, 20s, 30s, etc.
            fi
          done
          
          echo "✗ Docker push failed after $max_retries attempts" >&2
          exit 1
      - name: Push source code to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_SECRET }}
          HF_SPACE: ${{ env.HF_SPACE }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git push "https://${HF_USERNAME}:${HF_TOKEN}@huggingface.co/spaces/${HF_SPACE}" HEAD:main --force --verbose
