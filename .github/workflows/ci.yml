name: CI + CD to Hugging Face

on:
  push:
    branches: ["**"]
    tags: ["v*.*.*"]
  pull_request:
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"
  HF_SPACE: "sma-nas/Futurisys"
  HF_USERNAME: "sma-nas"

jobs:
  INSTALL-BUILD-TEST:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Installation dependances
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install build
      - name: Build package (sdist + wheel)
        run: python -m build
      - name: Install Build
        run: |
          pip install dist/*.whl || pip install dist/*.tar.gz
      - name: Tests
        run: |
          pytest --cov=app --cov-report=xml --cov-report=term-missing
      - name: Coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage.xml
  DEPLOY-TO-HF:
    needs: [INSTALL-BUILD-TEST]
    if: >
      success() && (
        startsWith(github.ref, 'refs/heads/main') ||
        startsWith(github.ref, 'refs/tags/v')
      )
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true




      # Refuser des .db suivis par Git (bloque le push HF)
      - name: Sanity — pas de .db versionnés
        run: |
          set -e
          if git ls-files "*.db" | grep -q .; then
            echo "::error ::Des fichiers .db sont suivis par Git. Faites :"
            echo "  git rm --cached ml_service.db && echo '*.db' >> .gitignore && git commit -m 'Ignore .db'"
            exit 1
          fi

      # Préparer un dossier d'upload sans .git/.github ni *.db
      - name: Préparer le dossier de déploiement (sources uniquement)
        run: |
          set -e
          rm -rf deploy && mkdir deploy
          rsync -a --delete \
            --exclude='.git' --exclude='.github' \
            --exclude='*.db' --exclude='**/*.db' \
            ./ deploy/

      # LFS pour les modèles .pkl (critique pour model.pkl)
      - name: Push sources vers la Space (HF build)
        env:
          HF_TOKEN: ${{ secrets.HF_SECRET }}
          HF_SPACE: ${{ env.HF_SPACE }}
        run: |
          set -e
          cd deploy
          git init
          # Ensure we don't push LFS configuration or pointers. Remove any
          # .gitattributes copied into the temporary deploy repo so the remote
          # pre-receive hook won't treat files as LFS pointers.
          rm -f .gitattributes || true

          # Ensure the model file is the actual blob from the checked-out
          # workspace (not an LFS pointer). Copy it from the runner's working
          # directory if present.
          if [ -f ../app/ml/model.pkl ]; then
            mkdir -p app/ml
            cp ../app/ml/model.pkl app/ml/model.pkl
          fi

          # Add everything and commit
          git add .
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Deploy ${GITHUB_SHA}"
          git branch -M main
          git remote add origin "https://oauth2:${HF_TOKEN}@huggingface.co/spaces/${HF_SPACE}"
          git push -f origin main

